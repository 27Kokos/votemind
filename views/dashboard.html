<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Кабинет — VoteMind</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/header.css">
  <link rel="stylesheet" href="/css/profile.css">
  <link rel="stylesheet" href="/css/notifications.css">  
  <link rel="stylesheet" href="/css/adaptive.css">

</head>
<body>

  <!-- Хедер (полная копия из profile.html) -->
<header>
  <div class="header-wrapper relative">
    <!-- Обёртка для борьбы с артефактами Chrome -->
    <div class="header-border-frame">
      <div class="header-container">
        <a href="/dashboard" class="font-bold">VoteMind</a>
        <div class="flex-between" style="gap: 12px;">
          <a href="#" class="relative" onclick="window.toggleNotifications(event)">
            <i class="fas fa-bell text-base hover:text-indigo-600"></i>
            <span id="notification-badge" class="hidden absolute -top-1 -right-1 bg-indigo-600 text-white text-xs rounded-full w-4 h-4 flex items-center justify-center">0</span>
          </a>
          <a href="/profile" class="flex-between hover:bg-gray-100 px-2 py-1 rounded-lg" style="gap: 6px;">
            <img id="header-avatar" src="/img/default-avatar.png" class="avatar" alt="Профиль">
            <span class="text-xs font-medium">Профиль</span>
          </a>
          <a href="/auth/logout" class="text-xs text-red-600 hover:text-red-800">Выйти</a>
        </div>
      </div>
    </div>

    <!-- Меню уведомлений -->
    <div id="notifications-menu" class="glass hidden w-80 rounded-xl shadow-xl z-50 overflow-hidden">
      <div class="p-3 border-b border-white/30 text-sm font-medium text-gray-700">Уведомления</div>
      <div id="notifications-list">
        <div class="p-3 text-gray-500 text-sm">Загрузка...</div>
      </div>
    </div>
  </div>
</header>


  <div class="spacer" style="height: 80px;"></div>


  <main class="container mt-8">
    <div class="text-center mb-8">
      <h1 class="text-3xl font-bold">Добро пожаловать</h1>
      <p class="text-gray-400">Создайте комнату или присоединитесь к существующей</p>
    </div>

   <!-- Создание комнаты -->
<div class="card p-6 mb-6">
  <h2 class="section-title">
    <i class="fas fa-plus-circle text-indigo-400"></i> Создать комнату
  </h2>
  <form id="create-room-form" action="/rooms" method="POST"> <!-- ✅ Добавь -->
    <div class="form-field">
      <label class="form-label">Название</label>
      <input type="text" name="name" placeholder="Например: Моя группа" class="form-input" required>
    </div>
    <div class="form-field">
      <label class="form-label">Описание (опционально)</label>
      <textarea name="description" rows="3" placeholder="Что это за комната?" class="form-input"></textarea>
    </div>
    <button type="submit" class="btn-primary">Создать</button>
  </form>
</div>


    <!-- Присоединение -->
<div class="card p-6 mb-6">
  <h2 class="section-title">
    <i class="fas fa-door-open text-blue-400"></i> Присоединиться к комнате
  </h2>
  <form id="join-room-form" action="/rooms/join" method="POST"> <!-- ✅ Добавь -->
    <div class="form-field">
      <label class="form-label">Код приглашения</label>
      <input type="text" name="inviteCode" maxlength="6" placeholder="AB12CD" class="form-input" required>
    </div>
    <button type="submit" class="btn-primary btn-info">Присоединиться</button>
  </form>
</div>


    <!-- Мои комнаты -->
    <div class="card p-6 mb-6">
      <h2 class="section-title">
        <i class="fas fa-users text-purple-400"></i> Мои комнаты
      </h2>
      <div id="rooms-list">
        <p class="text-gray-500 text-sm">Пока нет комнат. Создайте первую!</p>
      </div>
    </div>

    <!-- Кнопка -->
    <div class="text-center mb-8">
      <button onclick="openProposalsModal()" class="glass-btn">
        <i class="fas fa-hand-paper"></i> Просмотреть предложения
      </button>
    </div>
  </main>

  <!-- Модалка предложений -->
  <div id="proposals-modal" class="modal-overlay hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Новые предложения</h2>
        <button onclick="closeProposalsModal()" class="modal-close">&times;</button>
      </div>
      <div id="proposals-list">
        <p class="text-gray-400">Загрузка...</p>
      </div>
    </div>
  </div>

  <!-- JS -->
  <script src="/js/notifications.js"></script>
  <script src="/js/header.js"></script>
  <script>
    // Липкий хедер
    const headerWrapper = document.querySelector('.header-wrapper');
    window.addEventListener('scroll', () => {
      if (window.scrollY > 100) {
        headerWrapper.classList.add('sticky');
      } else {
        headerWrapper.classList.remove('sticky');
      }
    });

    // Наблюдатель
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) entry.target.classList.add('visible');
      });
    }, { threshold: 0.1 });

    document.querySelectorAll('.card').forEach(el => observer.observe(el));

    // Загрузка комнат
    async function loadRooms() {
      try {
        const res = await fetch('/rooms/my');
        const rooms = await res.json();
        const container = document.getElementById('rooms-list');
        container.innerHTML = '';

        if (rooms.length === 0) {
          container.innerHTML = '<p class="text-gray-500 text-sm">Пока нет комнат. Создайте первую!</p>';
          return;
        }

        rooms.forEach(room => {
          const isOwner = room.is_owner;
          const roleText = isOwner ? 'Владелец' : 'Участник';
          const roleClass = isOwner ? 'room-role' : 'room-role bg-blue-600';
          
          const el = document.createElement('a');
          el.href = `/room/${room.id}`;
          el.className = 'room-card';
          el.innerHTML = `
            <h3 class="room-name">${room.name}</h3>
            <p class="room-desc">${room.description || 'Без описания'}</p>
            <p class="room-code">Код: <strong>${room.invite_code}</strong></p>
            <span class="${roleClass}">${roleText}</span>
          `;
          container.appendChild(el);
        });
      } catch (err) {
        console.error(err);
      }
    }

    // Предложения — логика
    async function loadProposals() {
      const list = document.getElementById('proposals-list');
      list.innerHTML = '<p class="text-gray-400">Загрузка...</p>';

      try {
        const rooms = await fetch('/rooms/my').then(r => r.json());
        const ownerRooms = rooms.filter(r => r.is_owner);
        if (ownerRooms.length === 0) {
          list.innerHTML = '<p class="text-gray-400">Вы не владеете комнатами</p>';
          return;
        }

        const all = [];
        for (const r of ownerRooms) {
          const res = await fetch(`/proposals/room/${r.id}`);
          if (res.ok) all.push(...await res.json());
        }

        if (all.length === 0) {
          list.innerHTML = '<p class="text-gray-400">Нет предложений</p>';
          return;
        }

        list.innerHTML = '';
        all.forEach(p => {
          const item = document.createElement('div');
          item.className = 'p-3 border-b border-gray-700';
          item.innerHTML = `
            <div class="font-medium text-white">${p.question}</div>
            <div class="text-sm text-gray-400">от @${p.username} в "${p.room_name}"</div>
            <div class="mt-3 space-x-2">
              <button onclick="approveProposal(${p.id})" class="btn-primary btn-success text-xs">✅ Одобрить</button>
              <button onclick="rejectProposal(${p.id})" class="btn-primary text-xs">❌ Отклонить</button>
            </div>
          `;
          list.appendChild(item);
        });
      } catch (err) {
        list.innerHTML = '<p class="text-red-400">Ошибка</p>';
      }
    }

    async function approveProposal(id) {
      const res = await fetch(`/proposals/approve/${id}`, { method: 'POST' });
      if (res.ok) {
        alert('Одобрено!');
        loadProposals();
        fetchGlobalNotifications();
      }
    }

    function rejectProposal(id) {
      if (confirm('Отклонить?')) {
        fetch(`/proposals/reject/${id}`, { method: 'POST' })
          .then(() => location.reload())
          .catch(() => alert('Ошибка'));
      }
    }

    function openProposalsModal() {
      document.getElementById('proposals-modal').classList.remove('hidden');
      loadProposals();
    }

    function closeProposalsModal() {
      document.getElementById('proposals-modal').classList.add('hidden');
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadRooms();
      fetchGlobalNotifications();
      setInterval(fetchGlobalNotifications, 10000);
    });

    
  </script>
</body>
</html>
