<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ö–∞–±–∏–Ω–µ—Ç ‚Äî VoteMind</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/light-theme.css">
  <link rel="stylesheet" href="/css/header.css">
  <link rel="stylesheet" href="/css/profile.css">
  <link rel="stylesheet" href="/css/notifications.css">  
  <link rel="stylesheet" href="/css/adaptive.css">

</head>
<body>

  <!-- –•–µ–¥–µ—Ä (–ø–æ–ª–Ω–∞—è –∫–æ–ø–∏—è –∏–∑ profile.html) -->
<header>
  <div class="header-wrapper relative">
    <!-- –û–±—ë—Ä—Ç–∫–∞ –¥–ª—è –±–æ—Ä—å–±—ã —Å –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞–º–∏ Chrome -->
    <div class="header-border-frame">
      <div class="header-container">
        <a href="/dashboard" class="font-bold">VoteMind</a>
        <div class="flex-between" style="gap: 12px;">
          <a href="#" class="relative" onclick="window.toggleNotifications(event)">
            <i class="fas fa-bell text-base hover:text-indigo-600"></i>
            <span id="notification-badge" class="hidden absolute -top-1 -right-1 bg-indigo-600 text-white text-xs rounded-full w-4 h-4 flex items-center justify-center">0</span>
          </a>
          <a href="#" class="ml-3" onclick="toggleTheme(event)">
            <i id="theme-icon" class="fas fa-moon"></i>
          </a>
          <a href="/profile" class="flex-between hover:bg-gray-100 px-2 py-1 rounded-lg" style="gap: 6px;">
            <img id="header-avatar" src="/img/default-avatar.png" class="avatar" alt="–ü—Ä–æ—Ñ–∏–ª—å">
            <span class="text-xs font-medium">–ü—Ä–æ—Ñ–∏–ª—å</span>
          </a>
          <a href="/auth/logout" class="text-xs text-red-600 hover:text-red-800">–í—ã–π—Ç–∏</a>
        </div>
      </div>
    </div>

    <!-- –ú–µ–Ω—é —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
    <div id="notifications-menu" class="glass hidden w-80 rounded-xl shadow-xl z-50 overflow-hidden">
      <div class="p-3 border-b border-white/30 text-sm font-medium text-gray-700">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
      <div id="notifications-list">
        <div class="p-3 text-gray-500 text-sm">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
      </div>
    </div>
  </div>
</header>


  <div class="spacer" style="height: 80px;"></div>


  <main class="container mt-8">
    <div class="text-center mb-8">
      <h1 class="text-3xl font-bold">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å</h1>
      <p class="text-gray-400">–°–æ–∑–¥–∞–π—Ç–µ –∫–æ–º–Ω–∞—Ç—É –∏–ª–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç–µ—Å—å –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π</p>
    </div>
    <div id="toast" class="hidden toast">
      <i class="fas fa-check-circle"></i> <span id="toast-message"></span>
    </div>
  <!-- –î–µ–π—Å—Ç–≤–∏—è -->
<div class="actions-grid mb-8">
  <!-- –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã -->
  <div class="card p-6">
    <h2 class="section-title">
      <i class="fas fa-plus-circle text-indigo-400"></i> –°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É
    </h2>
    <form id="create-room-form" action="/rooms" method="POST">
      <div class="form-field">
        <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
        <input type="text" name="name" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ú–æ—è –≥—Ä—É–ø–ø–∞" class="form-input" required>
      </div>
      <div class="form-field">
        <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
        <textarea name="description" rows="3" placeholder="–ß—Ç–æ —ç—Ç–æ –∑–∞ –∫–æ–º–Ω–∞—Ç–∞?" class="form-input"></textarea>
      </div>
      <button type="submit" class="btn-primary w-full">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
    </form>
  </div>

  <!-- –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ -->
  <div class="card p-6">
    <h2 class="section-title">
      <i class="fas fa-door-open text-blue-400"></i> –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è
    </h2>
    <form id="join-room-form" action="/rooms/join" method="POST">
      <div class="form-field">
        <label class="form-label">–ö–æ–¥ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è</label>
        <input type="text" name="inviteCode" maxlength="6" placeholder="AB12CD" class="form-input" required>
      </div>
      <button type="submit" class="btn-primary btn-info w-full">–í–æ–π—Ç–∏ –≤ –∫–æ–º–Ω–∞—Ç—É</button>
    </form>
  </div>
</div>

<!-- –ú–æ–∏ –∫–æ–º–Ω–∞—Ç—ã -->
<div class="card p-6 mb-8">
  <h2 class="section-title">
    <i class="fas fa-users text-purple-400"></i> –ú–æ–∏ –∫–æ–º–Ω–∞—Ç—ã
  </h2>
  <div id="rooms-list" class="space-y-3">
    <p class="text-gray-500 text-sm">–ü–æ–∫–∞ –Ω–µ—Ç –∫–æ–º–Ω–∞—Ç. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é!</p>
  </div>
</div>

<!-- –ö–Ω–æ–ø–∫–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π -->
<div class="text-center mb-8">
  <button onclick="openProposalsModal()" class="glass-btn relative">
    <i class="fas fa-hand-paper"></i> 
    <span>–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è</span>
    <span id="proposals-badge" class="hidden absolute -top-2 -right-2 bg-red-600 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">0</span>
  </button>
</div>

  </main>

  <!-- –ú–æ–¥–∞–ª–∫–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π -->
  <div id="proposals-modal" class="modal-overlay hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">–ù–æ–≤—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è</h2>
        <button onclick="closeProposalsModal()" class="modal-close">&times;</button>
      </div>
      <div id="proposals-list">
        <p class="text-gray-400">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
      </div>
    </div>
  </div>
<!-- –û–Ω–±–æ—Ä–¥–∏–Ω–≥: –ü–æ–¥—Å–∫–∞–∑–∫–∞ 1 -->
<div id="onboarding-overlay" class="onboarding-overlay"></div>

<div id="onboarding-tooltip" class="onboarding-tooltip">
  <div class="onboarding-content">
    <h3>üéØ –°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ—é –ø–µ—Ä–≤—É—é –∫–æ–º–Ω–∞—Ç—É</h3>
    <p>–ó–¥–µ—Å—å –≤—ã –±—É–¥–µ—Ç–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è –∏ —É–ø—Ä–∞–≤–ª—è—Ç—å –æ–±—Å—É–∂–¥–µ–Ω–∏—è–º–∏.</p>
    <button onclick="closeOnboarding()" class="btn-modal save">–ü–æ–Ω—è—Ç–Ω–æ!</button>
  </div>
  <div class="onboarding-arrow"></div>
</div>



  <!-- JS -->
  <script src="/js/notifications.js"></script>
  <script src="/js/header.js"></script>
  <script src="/js/dashboard.js"></script>
  <script>
    // –õ–∏–ø–∫–∏–π —Ö–µ–¥–µ—Ä
    const headerWrapper = document.querySelector('.header-wrapper');
    window.addEventListener('scroll', () => {
      if (window.scrollY > 100) {
        headerWrapper.classList.add('sticky');
      } else {
        headerWrapper.classList.remove('sticky');
      }
    });

    // –ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) entry.target.classList.add('visible');
      });
    }, { threshold: 0.1 });

    document.querySelectorAll('.card').forEach(el => observer.observe(el));

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–º–Ω–∞—Ç
    async function loadRooms() {
      try {
        const res = await fetch('/rooms/my');
        const rooms = await res.json();
        const container = document.getElementById('rooms-list');
        container.innerHTML = '';

          if (rooms.length === 0) {
            container.innerHTML = `
              <p class="text-center text-gray-500 text-sm py-4">
                <i class="fas fa-inbox text-xl mb-2 opacity-60"></i><br>
                –ü–æ–∫–∞ –Ω–µ—Ç –∫–æ–º–Ω–∞—Ç
              </p>`;
            return;
          }

        rooms.forEach(room => {
          const isOwner = room.is_owner;
          const roleText = isOwner ? '–í–ª–∞–¥–µ–ª–µ—Ü' : '–£—á–∞—Å—Ç–Ω–∏–∫';
          const roleClass = isOwner ? 'room-role' : 'room-role bg-blue-600';
          
          const el = document.createElement('a');
          el.href = `/room/${room.id}`;
          el.className = 'room-card';
          el.innerHTML = `
            <h3 class="room-name">${room.name}</h3>
            <p class="room-desc">${room.description || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'}</p>
            <p class="room-code">–ö–æ–¥: <strong>${room.invite_code}</strong></p>
            <span class="${roleClass}">${roleText}</span>
          `;
          container.appendChild(el);
          el.style.opacity = '0';
          el.style.transform = 'translateY(20px)';
          container.appendChild(el);
          // –ê–Ω–∏–º–∞—Ü–∏—è
          setTimeout(() => {
            el.style.transition = 'all 0.3s ease';
            el.style.opacity = '1';
            el.style.transform = 'translateY(0)';
          }, 10);

        });
      } catch (err) {
        console.error(err);
      }
    }

    // –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è ‚Äî –ª–æ–≥–∏–∫–∞
    async function loadProposals() {
      const list = document.getElementById('proposals-list');
      list.innerHTML = '<p class="text-gray-400">–ó–∞–≥—Ä—É–∑–∫–∞...</p>';

      try {
        const rooms = await fetch('/rooms/my').then(r => r.json());
        const ownerRooms = rooms.filter(r => r.is_owner);
        if (ownerRooms.length === 0) {
          list.innerHTML = '<p class="text-gray-400">–í—ã –Ω–µ –≤–ª–∞–¥–µ–µ—Ç–µ –∫–æ–º–Ω–∞—Ç–∞–º–∏</p>';
          return;
        }

        const all = [];
        for (const r of ownerRooms) {
          const res = await fetch(`/proposals/room/${r.id}`);
          if (res.ok) all.push(...await res.json());
        }

        if (all.length === 0) {
          list.innerHTML = '<p class="text-gray-400">–ù–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π</p>';
          return;
        }

        list.innerHTML = '';
        all.forEach(p => {
          const item = document.createElement('div');
          item.className = 'p-3 border-b border-gray-700';
          item.innerHTML = `
            <div class="font-medium text-white">${p.question}</div>
            <div class="text-sm text-gray-400">–æ—Ç @${p.username} –≤ "${p.room_name}"</div>
            <div class="mt-3 space-x-2">
              <button onclick="approveProposal(${p.id})" class="btn-primary btn-success text-xs">‚úÖ –û–¥–æ–±—Ä–∏—Ç—å</button>
              <button onclick="rejectProposal(${p.id})" class="btn-primary text-xs">‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
            </div>
          `;
          list.appendChild(item);
        });
      } catch (err) {
        list.innerHTML = '<p class="text-red-400">–û—à–∏–±–∫–∞</p>';
      }
      // –ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π ‚Äî –æ–±–Ω–æ–≤–∏ –±–µ–π–¥–∂
      const badge = document.getElementById('proposals-badge');
        if (all.length > 0) {
          badge.classList.remove('hidden');
          badge.textContent = all.length > 9 ? '9+' : all.length;
        } else {
          badge.classList.add('hidden');
        }
    }

    async function approveProposal(id) {
      const res = await fetch(`/proposals/approve/${id}`, { method: 'POST' });
      if (res.ok) {
        alert('–û–¥–æ–±—Ä–µ–Ω–æ!');
        loadProposals();
        fetchGlobalNotifications();
      }
    }

    function rejectProposal(id) {
      if (confirm('–û—Ç–∫–ª–æ–Ω–∏—Ç—å?')) {
        fetch(`/proposals/reject/${id}`, { method: 'POST' })
          .then(() => location.reload())
          .catch(() => alert('–û—à–∏–±–∫–∞'));
      }
    }

    function openProposalsModal() {
      document.getElementById('proposals-modal').classList.remove('hidden');
      loadProposals();
    }

    function closeProposalsModal() {
      document.getElementById('proposals-modal').classList.add('hidden');
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadRooms();
      fetchGlobalNotifications();
      setInterval(fetchGlobalNotifications, 10000);
    });

    document.addEventListener('keydown', (e) => {
      if (e.ctrlKey && e.key === 'n') {
        e.preventDefault();
        document.querySelector('[name="name"]')?.focus();
      }
      if (e.ctrlKey && e.key === 'j') {
        e.preventDefault();
        document.querySelector('[name="inviteCode"]')?.focus();
      }
      if (e.key === 'Escape') {
        closeProposalsModal();
        document.getElementById('onboarding-overlay')?.classList.contains('active') && closeOnboarding();
      }
    });

  </script>
</body>
</html>
